version: 2.1

orbs:
  node: circleci/node@5.2.0

jobs:
  build_and_test:
    docker:
      - image: cimg/python:3.11-node
    resource_class: large
    working_directory: ~/project
    environment:
      DJANGO_SETTINGS_MODULE: "habit_tracker_backend.settings"
      PYTHONUNBUFFERED: "1"
      VENV_DIR: "venv"
      TARGET_DIR: "/tmp/habit-tracker-prod"
      GITHUB_REPO_OWNER: "JuanAlvarezP"
      GITHUB_REPO_NAME: "habit-tracker"
    steps:
      - checkout

      # --- Notify Start (GitHub: pending) ---
      - run:
          name: "Notify start (GitHub: pending)"
          when: always
          command: |
            if [ -n "${GH_TOKEN}" ]; then
              COMMIT_SHA="${CIRCLE_SHA1}"
              curl -sS -X POST \
                -H "Authorization: token ${GH_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/statuses/${COMMIT_SHA}" \
                -d "{
                  \"state\": \"pending\",
                  \"target_url\": \"${CIRCLE_BUILD_URL}\",
                  \"description\": \"‚è≥ Pipeline en ejecuci√≥n...\",
                  \"context\": \"CircleCI Pipeline\"
                }" || true
              echo "Notificaci√≥n enviada a GitHub: pending"
            else
              echo "GH_TOKEN no configurado; se omite notificaci√≥n inicial."
            fi

      # --- Backend: venv + deps ---
      - run:
          name: "Backend | Setup venv + pip deps"
          command: |
            python -m venv "${VENV_DIR}"
            . "${VENV_DIR}/bin/activate"
            python -m pip install --upgrade pip
            ( test -f requirements.txt && pip install -r requirements.txt ) \
              || ( test -f habit_tracker_backend/requirements.txt && pip install -r habit_tracker_backend/requirements.txt ) \
              || true
            pip install pytest pytest-django flake8 coverage gunicorn || true

      # --- Backend: migrations (best effort) ---
      - run:
          name: "Backend | Django migrations"
          command: |
            . "${VENV_DIR}/bin/activate"
            export DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}
            ( python manage.py makemigrations --noinput || true )
            ( python manage.py migrate --noinput || true )

      # --- Backend: flake8 ---
      - run:
          name: "Backend | flake8"
          command: |
            . "${VENV_DIR}/bin/activate"
            flake8 --exclude=migrations,venv,habit-tracker-frontend,build . || true

      # --- Backend: pytest + coverage ---
      - run:
          name: "Backend | pytest + coverage"
          command: |
            . "${VENV_DIR}/bin/activate"
            coverage run -m pytest || true
            coverage report -m || true
            coverage xml -o coverage.xml || true

      # --- Frontend: npm ci / lint / test / build ---
      - run:
          name: "Frontend | npm ci"
          command: |
            if [ -d "habit-tracker-frontend" ]; then
              cd habit-tracker-frontend
              ( npm ci || npm install )
            else
              echo "No se encontr√≥ habit-tracker-frontend; se omite."
            fi

      - run:
          name: "Frontend | lint"
          command: |
            if [ -f "habit-tracker-frontend/package.json" ]; then
              cd habit-tracker-frontend
              ( npm run lint || echo "lint skipped or failed" )
            fi

      - run:
          name: "Frontend | tests"
          command: |
            if [ -f "habit-tracker-frontend/package.json" ]; then
              cd habit-tracker-frontend
              ( npm test -- --ci --watchAll=false || echo "tests skipped or failed" )
            fi

      - run:
          name: "Frontend | build"
          command: |
            if [ -f "habit-tracker-frontend/package.json" ]; then
              cd habit-tracker-frontend
              ( npm run build || echo "build failed or skipped" )
            fi

      # --- Simulated Deploy to /tmp + copy artifacts ---
      - run:
          name: "Deploy simulado a /tmp"
          command: |
            rm -rf "${TARGET_DIR}"
            mkdir -p "${TARGET_DIR}/backend" "${TARGET_DIR}/frontend"

            rsync -av --exclude='venv' --exclude='.git' --exclude='node_modules' ./ "${TARGET_DIR}/backend/" || true

            if [ -d "habit-tracker-frontend/build" ]; then
              rsync -av habit-tracker-frontend/build/ "${TARGET_DIR}/frontend/" || true
            else
              echo "No hay build de frontend; skip."
            fi
            echo "Artefactos listos en ${TARGET_DIR}"

      # --- Smoke test con Gunicorn ---
      - run:
          name: "Smoke test Gunicorn (127.0.0.1:8001)"
          command: |
            . "${VENV_DIR}/bin/activate"

            # Verificar Django
            python -c "import importlib.util, sys; sys.exit(0) if importlib.util.find_spec('django') else sys.exit(1)"

            if [ "$?" -eq 0 ]; then
              echo "Django encontrado. Iniciando smoke test."
              export DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}
              
              # ( python manage.py collectstatic --noinput || echo "collectstatic skipped" ) # <--- L√çNEA COMENTADA
              
              pkill -f 'gunicorn' || true # Limpieza previa

              APP_MODULE=$(python -c "import os; m=os.environ.get('DJANGO_SETTINGS_MODULE','').replace('.settings',''); print(f'{m}.wsgi:application' if m else 'wsgi:application')")

              echo "Iniciando Gunicorn con 1 worker..."
              nohup "${VENV_DIR}/bin/gunicorn" --chdir . "${APP_MODULE}" -b 127.0.0.1:8001 --workers 1 > gunicorn.log 2>&1 &
              
              echo "Esperando 5 segundos a que Gunicorn inicie..."
              sleep 5

              if curl -f http://127.0.0.1:8001/; then
                echo "Smoke test (curl) EXITOSO."
              else
                echo "Smoke test (curl) FALL√ì."
                echo "--- Mostrando log de Gunicorn (gunicorn.log) ---"
                cat gunicorn.log
                echo "--------------------------------------------------"
                exit 1 # Falla el build
              fi
              
              pkill -f 'gunicorn' || true # Limpieza final
            else
              echo "Django no disponible; se omite smoke test."
            fi

      # --- Empaquetar y publicar artefactos ---
      - run:
          name: "Empaquetar artefactos"
          command: |
            mkdir -p artifacts || true
            cp -r coverage.* artifacts/ 2>/dev/null || true
            cp -r gunicorn.log artifacts/ 2>/dev/null || true
            echo "Resultado del build: SUCCESS (si el job termin√≥)" > artifacts/build_status.txt || true
            tar -C /tmp -czf artifacts/habit-tracker-prod.tgz habit-tracker-prod || true

      - store_artifacts:
          path: artifacts
          destination: artifacts

      # --- Notificaciones finales a GitHub ---
      - run:
          name: "Notify success (GitHub: success)"
          when: on_success
          command: |
            if [ -n "${GH_TOKEN}" ]; then
              COMMIT_SHA="${CIRCLE_SHA1}"
              curl -sS -X POST \
                -H "Authorization: token ${GH_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/statuses/${COMMIT_SHA}" \
                -d "{
                  \"state\": \"success\",
                  \"target_url\": \"${CIRCLE_BUILD_URL}\",
                  \"description\": \"Pipeline passed\",
                  \"context\": \"CircleCI Pipeline\"
                }" || true
            fi

      - run:
          name: "Notify failure (GitHub: failure)"
          when: on_fail
          command: |
            if [ -n "${GH_TOKEN}" ]; then
              COMMIT_SHA="${CIRCLE_SHA1}"
              curl -sS -X POST \
                -H "Authorization: token ${GH_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/statuses/${COMMIT_SHA}" \
                -d "{
                  \"state\": \"failure\",
                  \"target_url\": \"${CIRCLE_BUILD_URL}\",
                  \"description\": \"Pipeline failed\",
                  \"context\": \"CircleCI Pipeline\"
                }" || true
            fi

  #Job para emular "Start Local Servers"
  start_local_servers:
    docker:
      - image: cimg/python:3.11-node
    working_directory: ~/project
    environment:
      DJANGO_SETTINGS_MODULE: "habit_tracker_backend.settings"
      PYTHONUNBUFFERED: "1"
      VENV_DIR: "venv"
    steps:
      - checkout
      - run:
          name: "Preparar backend y frontend"
          command: |
            python -m venv "${VENV_DIR}"
            . "${VENV_DIR}/bin/activate"
            python -m pip install --upgrade pip
            ( test -f requirements.txt && pip install -r requirements.txt ) \
              || ( test -f habit_tracker_backend/requirements.txt && pip install -r habit_tracker_backend/requirements.txt ) \
              || true
            export DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}
            ( python manage.py migrate --noinput || true )
            if [ -d "habit-tracker-frontend" ]; then
              cd habit-tracker-frontend
              ( npm ci || npm install )
              cd ..
            fi
      - run:
          name: "Iniciar Django y React (verificaci√≥n breve)"
          command: |
            . "${VENV_DIR}/bin/activate"
            nohup python manage.py runserver 0.0.0.0:8000 > django_server.log 2>&1 &
            echo $! > django_server.pid
            if [ -d "habit-tracker-frontend" ]; then
              cd habit-tracker-frontend
              nohup npm start -- --port 3000 > ../react_server.log 2>&1 &
              echo $! > ../react_server.pid
              cd ..
            fi
            sleep 8
            if [ -f django_server.pid ] && ps -p "$(cat django_server.pid)" > /dev/null 2>&1; then
              echo "Django server iniciado (PID: $(cat django_server.pid))"
            else
              echo "Django no se inici√≥. Ver django_server.log"
            fi
            if [ -f react_server.pid ] && ps -p "$(cat react_server.pid)" > /dev/null 2>&1; then
              echo "React server iniciado (PID: $(cat react_server.pid))"
            else
              echo "React no se inici√≥. Ver react_server.log"
            fi
            ( kill $(cat django_server.pid) 2>/dev/null || true )
            ( kill $(cat react_server.pid) 2>/dev/null || true
            ) || true
      - store_artifacts:
          path: django_server.log
          destination: servers/django_server.log
      - store_artifacts:
          path: react_server.log
          destination: servers/react_server.log

  # ============================================
  # JOB: SAST - An√°lisis Est√°tico con ESLint
  # ============================================
  sast_eslint:
    docker:
      - image: cimg/node:18.19
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: "üìã SAST - An√°lisis de Seguridad Est√°tico"
          command: |
            echo "=========================================="
            echo "üîç SAST - Static Application Security Testing"
            echo "Herramienta: ESLint + eslint-plugin-security"
            echo "=========================================="

      - restore_cache:
          keys:
            - v1-npm-sast-{{ checksum "habit-tracker-frontend/package.json" }}
            - v1-npm-sast-

      - run:
          name: "üì¶ Instalar dependencias"
          command: |
            cd habit-tracker-frontend
            npm install

      - save_cache:
          key: v1-npm-sast-{{ checksum "habit-tracker-frontend/package.json" }}
          paths:
            - habit-tracker-frontend/node_modules

      - run:
          name: "üîç Ejecutar ESLint con an√°lisis de seguridad"
          command: |
            cd habit-tracker-frontend
            mkdir -p ~/test-results/eslint

            # Generar reportes
            npm run lint -- --format json --output-file ~/test-results/eslint/eslint-report.json || true
            npm run lint -- --format html --output-file ~/test-results/eslint/eslint-report.html || true
            npm run lint || echo "‚ö†Ô∏è  ESLint encontr√≥ problemas"

            echo ""
            echo "üìä Reportes generados en test-results/eslint/"

      - run:
          name: "üìà Resumen de an√°lisis SAST"
          command: |
            echo "=========================================="
            echo "üìä RESUMEN DE AN√ÅLISIS EST√ÅTICO (SAST)"
            echo "=========================================="

            if [ -f ~/test-results/eslint/eslint-report.json ]; then
              TOTAL=$(cat ~/test-results/eslint/eslint-report.json | grep -o '"errorCount":[0-9]*' | cut -d':' -f2 | awk '{s+=$1} END {print s}' || echo "0")
              echo "Total de issues: $TOTAL"
              echo "‚úÖ An√°lisis SAST completado"
            fi
            echo "=========================================="

      - store_artifacts:
          path: ~/test-results/eslint
          destination: sast-reports

      - store_test_results:
          path: ~/test-results

  # ============================================
  # JOB: DAST - An√°lisis Din√°mico con OWASP ZAP
  # ============================================
  dast_owasp_zap:
    docker:
      - image: cimg/python:3.11-node
    resource_class: large
    working_directory: ~/project
    environment:
      DJANGO_SETTINGS_MODULE: "habit_tracker_backend.settings"
      VENV_DIR: "venv"
    steps:
      - checkout

      - run:
          name: "üìã DAST - An√°lisis de Seguridad Din√°mico"
          command: |
            echo "=========================================="
            echo "üéØ DAST - Dynamic Application Security Testing"
            echo "Herramienta: OWASP ZAP"
            echo "=========================================="

      - restore_cache:
          keys:
            - v1-pip-dast-{{ checksum "requirements.txt" }}
            - v1-pip-dast-

      - run:
          name: "üêç Configurar Backend"
          command: |
            python -m venv "${VENV_DIR}"
            . "${VENV_DIR}/bin/activate"
            pip install --upgrade pip
            pip install -r requirements.txt
            python manage.py migrate --noinput

      - save_cache:
          key: v1-pip-dast-{{ checksum "requirements.txt" }}
          paths:
            - venv

      - restore_cache:
          keys:
            - v1-npm-dast-{{ checksum "habit-tracker-frontend/package.json" }}
            - v1-npm-dast-

      - run:
          name: "‚öõÔ∏è  Configurar y Build Frontend"
          command: |
            cd habit-tracker-frontend
            npm install
            npm run build

      - save_cache:
          key: v1-npm-dast-{{ checksum "habit-tracker-frontend/package.json" }}
          paths:
            - habit-tracker-frontend/node_modules

      - run:
          name: "üöÄ Iniciar aplicaci√≥n"
          background: true
          command: |
            . "${VENV_DIR}/bin/activate"
            python manage.py runserver 0.0.0.0:8000 &
            cd habit-tracker-frontend
            npx serve -s build -l 3000 &
            sleep 15

      - run:
          name: "üîç Verificar servicios"
          command: |
            echo "Verificando Backend..."
            curl -f http://localhost:8000/ || echo "‚ö†Ô∏è  Backend no responde"

            echo "Verificando Frontend..."
            curl -f http://localhost:3000/ || echo "‚ö†Ô∏è  Frontend no responde"

      - run:
          name: "üì• Instalar OWASP ZAP"
          command: |
            sudo apt-get update
            sudo apt-get install -y wget openjdk-11-jre-headless

            cd /tmp
            wget -q https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2.14.0_Linux.tar.gz
            tar -xzf ZAP_2.14.0_Linux.tar.gz

            # Verificar instalaci√≥n
            java -version
            echo "‚úÖ OWASP ZAP instalado"

      - run:
          name: "üéØ Ejecutar escaneo DAST"
          command: |
            mkdir -p ~/test-results/zap

            echo "Escaneando Frontend..."
            /tmp/ZAP_2.14.0/zap.sh -cmd \
              -quickurl http://localhost:3000 \
              -quickprogress \
              -quickout ~/test-results/zap/zap-frontend-report.html \
              || echo "‚ö†Ô∏è  Escaneo completado con alertas"

            echo "Escaneando API..."
            /tmp/ZAP_2.14.0/zap.sh -cmd \
              -quickurl http://localhost:8000/api/habits/ \
              -quickprogress \
              -quickout ~/test-results/zap/zap-api-report.html \
              || echo "‚ö†Ô∏è  Escaneo API completado"

      - run:
          name: "üìä Resumen de an√°lisis DAST"
          command: |
            echo "=========================================="
            echo "üìä RESUMEN DE AN√ÅLISIS DIN√ÅMICO (DAST)"
            echo "=========================================="

            if [ -f ~/test-results/zap/zap-frontend-report.html ]; then
              echo "‚úÖ Reporte DAST generado"
              echo ""
              echo "Reportes disponibles:"
              echo "  - Frontend: zap-frontend-report.html"
              echo "  - API: zap-api-report.html"
            fi
            echo "=========================================="

      - store_artifacts:
          path: ~/test-results/zap
          destination: dast-reports

workflows:
  version: 2

  # Workflow principal de CI/CD
  ci_pipeline:
    jobs:
      - build_and_test:
          context: [github-notify]

  # Workflow de seguridad SAST & DAST
  security_pipeline:
    jobs:
      - sast_eslint:
          name: "üîç SAST - An√°lisis Est√°tico"

      - dast_owasp_zap:
          name: "üéØ DAST - An√°lisis Din√°mico"
          requires:
            - "üîç SAST - An√°lisis Est√°tico"
