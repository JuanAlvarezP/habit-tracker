version: 2.1

orbs:
  node: circleci/node@5.2.0
  python: circleci/python@2.1.1

# ============================================
# PIPELINE CI - INTEGRACIÃ“N CONTINUA
# Build, Tests, SAST, DAST y Artefactos
# ============================================

jobs:
  # ============================================
  # JOB 1: BUILD Y TESTS - BACKEND
  # ============================================
  build_backend:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: "ğŸ Instalar dependencias Backend"
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install pytest pytest-django coverage flake8

      - run:
          name: "ğŸ” Linting con Flake8"
          command: |
            . venv/bin/activate
            flake8 --exclude=migrations,venv,habit-tracker-frontend . || true

      - run:
          name: "ğŸ§ª Tests unitarios con coverage"
          command: |
            . venv/bin/activate
            export DJANGO_SETTINGS_MODULE=habit_tracker_backend.settings
            python manage.py migrate --noinput
            coverage run -m pytest
            coverage report -m
            coverage xml

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: coverage.xml
          destination: coverage-reports

      - persist_to_workspace:
          root: ~/project
          paths:
            - .

  # ============================================
  # JOB 2: BUILD Y TESTS - FRONTEND
  # ============================================
  build_frontend:
    docker:
      - image: cimg/node:18.19
    working_directory: ~/project/habit-tracker-frontend
    steps:
      - checkout:
          path: ~/project

      - restore_cache:
          keys:
            - v1-npm-deps-{{ checksum "package.json" }}
            - v1-npm-deps-

      - run:
          name: "ğŸ“¦ Instalar dependencias Frontend"
          command: npm install

      - save_cache:
          key: v1-npm-deps-{{ checksum "package.json" }}
          paths:
            - node_modules

      - run:
          name: "ğŸ” Linting con ESLint"
          command: npm run lint || true

      - run:
          name: "ğŸ§ª Tests unitarios con Jest"
          command: npm test -- --ci --watchAll=false --coverage || true

      - run:
          name: "ğŸ—ï¸  Build para producciÃ³n"
          command: npm run build

      - store_artifacts:
          path: build
          destination: frontend-build

      - persist_to_workspace:
          root: ~/project
          paths:
            - habit-tracker-frontend/build

  # ============================================
  # JOB 3: SAST - ANÃLISIS ESTÃTICO CON ESLINT
  # ============================================
  sast_eslint:
    docker:
      - image: cimg/node:18.19
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project

      - run:
          name: "ğŸ“‹ SAST - AnÃ¡lisis de Seguridad EstÃ¡tico"
          command: |
            echo "=========================================="
            echo "ğŸ” SAST - Static Application Security Testing"
            echo "Herramienta: ESLint + eslint-plugin-security"
            echo "=========================================="

      - run:
          name: "ğŸ” Ejecutar ESLint con anÃ¡lisis de seguridad"
          command: |
            cd habit-tracker-frontend
            mkdir -p ~/project/sast-reports

            # Generar reportes
            npm run lint -- --format json --output-file ~/project/sast-reports/eslint-report.json || true
            npm run lint -- --format html --output-file ~/project/sast-reports/eslint-report.html || true
            npm run lint || echo "âš ï¸  ESLint encontrÃ³ problemas de seguridad"

            echo ""
            echo "ğŸ“Š Reportes SAST generados en sast-reports/"

      - run:
          name: "ğŸ“ˆ Resumen de anÃ¡lisis SAST"
          command: |
            echo "=========================================="
            echo "ğŸ“Š RESUMEN DE ANÃLISIS ESTÃTICO (SAST)"
            echo "=========================================="
            if [ -f ~/project/sast-reports/eslint-report.json ]; then
              echo "âœ… AnÃ¡lisis SAST completado"
              echo "Ver reportes en artifacts/sast-reports"
            fi
            echo "=========================================="

      - store_artifacts:
          path: ~/project/sast-reports
          destination: sast-reports

  # ============================================
  # JOB 4: DAST - ANÃLISIS DINÃMICO CON SQLMAP
  # ============================================
  dast_sqlmap:
    docker:
      - image: cimg/python:3.11-node
    resource_class: large
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project

      - run:
          name: "ğŸ“‹ DAST - AnÃ¡lisis de Seguridad DinÃ¡mico"
          command: |
            echo "=========================================="
            echo "ğŸ’‰ DAST - Dynamic Application Security Testing"
            echo "Herramienta: SQLMap - SQL Injection Scanner"
            echo "=========================================="

      - run:
          name: "ğŸ Configurar Backend Django"
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            python manage.py migrate --noinput
            echo "âœ… Backend configurado"

      - run:
          name: "âš›ï¸  Instalar dependencias Frontend"
          command: |
            cd habit-tracker-frontend
            npm install

      - run:
          name: "ğŸš€ Iniciar aplicaciÃ³n Django en background"
          background: true
          command: |
            . venv/bin/activate
            python manage.py runserver 0.0.0.0:8000

      - run:
          name: "â³ Esperar a que Django inicie"
          command: |
            echo "Esperando 20 segundos a que Django inicie..."
            sleep 20
            curl -I http://localhost:8000/admin/ && echo "âœ… Django respondiendo" || echo "âš ï¸  Django no responde aÃºn"

      - run:
          name: "ğŸ’‰ Instalar SQLMap"
          command: |
            sudo apt-get update -qq
            sudo apt-get install -y sqlmap
            echo "âœ… SQLMap instalado"
            sqlmap --version

      - run:
          name: "ğŸ’‰ SQLMap - Escanear endpoints vulnerables"
          command: |
            mkdir -p ~/project/dast-reports

            echo "=========================================="
            echo "ğŸ¯ Target 1: Vulnerable Search by ID"
            echo "=========================================="

            sqlmap -u "http://localhost:8000/api/vulnerable-search/?id=1" \
              --batch \
              --level=5 \
              --risk=3 \
              --dbms=SQLite \
              --technique=BEUSTQ \
              --threads=5 \
              --tamper=space2comment \
              -v 3 \
              --random-agent \
              --flush-session \
              --output-dir=~/project/dast-reports || true

            echo ""
            echo "=========================================="
            echo "ğŸ¯ Target 2: Vulnerable User Search"
            echo "=========================================="

            sqlmap -u "http://localhost:8000/api/vulnerable-login/?name=admin" \
              --batch \
              --level=5 \
              --risk=3 \
              --dbms=SQLite \
              --technique=BEUSTQ \
              --threads=5 \
              -v 3 \
              --random-agent \
              --flush-session \
              --output-dir=~/project/dast-reports || true

            echo ""
            echo "=========================================="
            echo "ğŸ¯ Target 3: Habits API (protegido - comparaciÃ³n)"
            echo "=========================================="

            sqlmap -u "http://localhost:8000/api/habits/?id=1" \
              --batch \
              --level=3 \
              --risk=2 \
              -v 2 \
              --random-agent \
              --output-dir=~/project/dast-reports || true

      - run:
          name: "ğŸ“Š Resumen de anÃ¡lisis DAST"
          command: |
            echo "=========================================="
            echo "ğŸ“Š RESUMEN DE ANÃLISIS DINÃMICO (DAST)"
            echo "=========================================="
            echo "âœ… SQLMap completÃ³ el anÃ¡lisis de inyecciones SQL"
            echo "Ver reportes detallados en artifacts/dast-reports"
            echo "=========================================="

      - store_artifacts:
          path: ~/project/dast-reports
          destination: dast-reports

  # ============================================
  # JOB 5: BUILD DOCKER IMAGES
  # ============================================
  build_docker_images:
    docker:
      - image: cimg/base:2024.01
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: "ğŸ³ Build Backend Docker Image"
          command: |
            docker build -t habit-tracker-backend:${CIRCLE_SHA1} -f Dockerfile.backend .
            docker tag habit-tracker-backend:${CIRCLE_SHA1} habit-tracker-backend:latest
            echo "âœ… Backend image built"

      - run:
          name: "ğŸ³ Build Frontend Docker Image"
          command: |
            docker build -t habit-tracker-frontend:${CIRCLE_SHA1} -f Dockerfile.frontend ./habit-tracker-frontend
            docker tag habit-tracker-frontend:${CIRCLE_SHA1} habit-tracker-frontend:latest
            echo "âœ… Frontend image built"

      - run:
          name: "ğŸ’¾ Save Docker Images"
          command: |
            mkdir -p /tmp/docker-images
            docker save -o /tmp/docker-images/backend.tar habit-tracker-backend:${CIRCLE_SHA1}
            docker save -o /tmp/docker-images/frontend.tar habit-tracker-frontend:${CIRCLE_SHA1}

      - store_artifacts:
          path: /tmp/docker-images
          destination: docker-images

      - persist_to_workspace:
          root: /tmp
          paths:
            - docker-images

  # ============================================
  # JOB 6: SECURITY SCAN DE IMÃGENES DOCKER
  # ============================================
  scan_docker_images:
    docker:
      - image: cimg/base:2024.01
    steps:
      - attach_workspace:
          at: /tmp

      - setup_remote_docker

      - run:
          name: "ğŸ” Instalar Trivy"
          command: |
            wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
            sudo apt-get update
            sudo apt-get install -y trivy

      - run:
          name: "ğŸ” Cargar imÃ¡genes Docker"
          command: |
            docker load -i /tmp/docker-images/backend.tar
            docker load -i /tmp/docker-images/frontend.tar

      - run:
          name: "ğŸ” Escanear Backend con Trivy"
          command: |
            mkdir -p /tmp/trivy-reports
            trivy image --format json --output /tmp/trivy-reports/backend-scan.json habit-tracker-backend:${CIRCLE_SHA1} || true
            trivy image habit-tracker-backend:${CIRCLE_SHA1} || true

      - run:
          name: "ğŸ” Escanear Frontend con Trivy"
          command: |
            trivy image --format json --output /tmp/trivy-reports/frontend-scan.json habit-tracker-frontend:${CIRCLE_SHA1} || true
            trivy image habit-tracker-frontend:${CIRCLE_SHA1} || true

      - store_artifacts:
          path: /tmp/trivy-reports
          destination: trivy-reports

# ============================================
# WORKFLOWS
# ============================================
workflows:
  version: 2

  # PIPELINE CI COMPLETO
  ci_pipeline:
    jobs:
      # Fase 1: Build y Tests en paralelo
      - build_backend
      - build_frontend

      # Fase 2: AnÃ¡lisis de seguridad (SAST y DAST)
      - sast_eslint:
          requires:
            - build_frontend

      - dast_sqlmap:
          requires:
            - build_backend
            - build_frontend

      # Fase 3: Build de imÃ¡genes Docker
      - build_docker_images:
          requires:
            - sast_eslint
            - dast_sqlmap

      # Fase 4: Security scan de imÃ¡genes
      - scan_docker_images:
          requires:
            - build_docker_images
