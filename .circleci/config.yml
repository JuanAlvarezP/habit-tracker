version: 2.1

orbs:
  node: circleci/node@5.2.0

# ============================================
# JOB 1: SAST - An√°lisis Est√°tico con ESLint
# L√≠neas: 7-87
# ============================================
jobs:
  sast_eslint:
    docker:
      - image: cimg/node:18.19
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: "üìã SAST - An√°lisis de Seguridad Est√°tico"
          command: |
            echo "=========================================="
            echo "üîç SAST - Static Application Security Testing"
            echo "Herramienta: ESLint + eslint-plugin-security"
            echo "=========================================="

      - restore_cache:
          keys:
            - v1-npm-sast-{{ checksum "habit-tracker-frontend/package.json" }}
            - v1-npm-sast-

      - run:
          name: "üì¶ Instalar dependencias"
          command: |
            cd habit-tracker-frontend
            npm install

      - save_cache:
          key: v1-npm-sast-{{ checksum "habit-tracker-frontend/package.json" }}
          paths:
            - habit-tracker-frontend/node_modules

      - run:
          name: "üîç Ejecutar ESLint con an√°lisis de seguridad"
          command: |
            cd habit-tracker-frontend
            mkdir -p ~/test-results/eslint

            # Generar reportes
            npm run lint -- --format json --output-file ~/test-results/eslint/eslint-report.json || true
            npm run lint -- --format html --output-file ~/test-results/eslint/eslint-report.html || true
            npm run lint || echo "‚ö†Ô∏è  ESLint encontr√≥ problemas"

            echo ""
            echo "üìä Reportes generados en test-results/eslint/"

      - run:
          name: "üìà Resumen de an√°lisis SAST"
          command: |
            echo "=========================================="
            echo "üìä RESUMEN DE AN√ÅLISIS EST√ÅTICO (SAST)"
            echo "=========================================="

            if [ -f ~/test-results/eslint/eslint-report.json ]; then
              TOTAL=$(cat ~/test-results/eslint/eslint-report.json | grep -o '"errorCount":[0-9]*' | cut -d':' -f2 | awk '{s+=$1} END {print s}' || echo "0")
              echo "Total de issues: $TOTAL"
              echo "‚úÖ An√°lisis SAST completado"
            fi
            echo "=========================================="

      - store_artifacts:
          path: ~/test-results/eslint
          destination: sast-reports

      - store_test_results:
          path: ~/test-results

  # ============================================
  # JOB 2: DAST - An√°lisis Din√°mico con OWASP ZAP
  # L√≠neas: 78-260
  # ============================================
  dast_owasp_zap:
    docker:
      - image: cimg/python:3.11-node
    resource_class: large
    working_directory: ~/project
    environment:
      DJANGO_SETTINGS_MODULE: "habit_tracker_backend.settings"
      VENV_DIR: "venv"
    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: "üìã DAST - An√°lisis de Seguridad Din√°mico"
          command: |
            echo "=========================================="
            echo "üéØ DAST - Dynamic Application Security Testing"
            echo "Herramienta: OWASP ZAP (Docker)"
            echo "=========================================="

      - restore_cache:
          keys:
            - v1-pip-dast-{{ checksum "requirements.txt" }}
            - v1-pip-dast-

      - run:
          name: "üêç Configurar Backend"
          command: |
            python -m venv "${VENV_DIR}"
            . "${VENV_DIR}/bin/activate"
            pip install --upgrade pip
            pip install -r requirements.txt
            python manage.py migrate --noinput

      - save_cache:
          key: v1-pip-dast-{{ checksum "requirements.txt" }}
          paths:
            - venv

      - restore_cache:
          keys:
            - v1-npm-dast-{{ checksum "habit-tracker-frontend/package.json" }}
            - v1-npm-dast-

      - run:
          name: "‚öõÔ∏è  Configurar y Build Frontend"
          command: |
            cd habit-tracker-frontend
            npm install
            npm run build

      - save_cache:
          key: v1-npm-dast-{{ checksum "habit-tracker-frontend/package.json" }}
          paths:
            - habit-tracker-frontend/node_modules

      - run:
          name: "üöÄ Iniciar aplicaci√≥n"
          background: true
          command: |
            . "${VENV_DIR}/bin/activate"

            # Obtener IP del host para Docker
            HOST_IP=$(hostname -I | awk '{print $1}')
            echo "IP del host: $HOST_IP"

            # Iniciar Django
            echo "Iniciando Django en puerto 8000..."
            python manage.py runserver 0.0.0.0:8000 2>&1 | tee django.log &
            echo $! > /tmp/django.pid

            # Iniciar Frontend  
            echo "Iniciando Frontend en puerto 3000..."
            cd habit-tracker-frontend
            npx serve -s build -l 3000 2>&1 | tee ../frontend.log &
            echo $! > /tmp/frontend.pid

            # Mantener el proceso vivo
            tail -f /dev/null

      - run:
          name: "üîç Verificar servicios"
          command: |
            echo "========================================="
            echo "Verificaci√≥n de Servicios"
            echo "========================================="

            # Esperar a que los servicios inicien
            echo "Esperando 30 segundos a que los servicios inicien..."
            sleep 30

            # Verificar PIDs
            if [ -f /tmp/django.pid ]; then
              DJANGO_PID=$(cat /tmp/django.pid)
              if ps -p $DJANGO_PID > /dev/null 2>&1; then
                echo "‚úÖ Django corriendo (PID: $DJANGO_PID)"
              else
                echo "‚ùå Django no est√° corriendo"
              fi
            fi

            if [ -f /tmp/frontend.pid ]; then
              FRONTEND_PID=$(cat /tmp/frontend.pid)
              if ps -p $FRONTEND_PID > /dev/null 2>&1; then
                echo "‚úÖ Frontend corriendo (PID: $FRONTEND_PID)"
              else
                echo "‚ùå Frontend no est√° corriendo"
              fi
            fi

            # Intentar conexi√≥n m√∫ltiples veces
            echo ""
            echo "Verificando conectividad Backend..."
            DJANGO_OK=0
            for i in {1..10}; do
              if curl -s http://localhost:8000/admin/ > /dev/null 2>&1; then
                echo "‚úÖ Django respondiendo en http://localhost:8000/admin/"
                DJANGO_OK=1
                break
              fi
              echo "Intento $i/10: Django no responde, esperando..."
              sleep 3
            done

            echo ""
            echo "Verificando conectividad Frontend..."
            FRONTEND_OK=0
            for i in {1..10}; do
              if curl -s http://localhost:3000/ > /dev/null 2>&1; then
                echo "‚úÖ Frontend respondiendo en http://localhost:3000/"
                FRONTEND_OK=1
                break
              fi
              echo "Intento $i/10: Frontend no responde, esperando..."
              sleep 3
            done

            echo ""
            echo "========================================="
            echo "Resumen de Verificaci√≥n"
            echo "========================================="
            echo "Django: $([ $DJANGO_OK -eq 1 ] && echo '‚úÖ OK' || echo '‚ùå FAILED')"
            echo "Frontend: $([ $FRONTEND_OK -eq 1 ] && echo '‚úÖ OK' || echo '‚ùå FAILED')"

            echo ""
            echo "Logs de Django (√∫ltimas 30 l√≠neas):"
            tail -30 django.log 2>/dev/null || echo "No hay logs de Django"

            echo ""
            echo "Logs de Frontend (√∫ltimas 30 l√≠neas):"
            tail -30 frontend.log 2>/dev/null || echo "No hay logs de Frontend"

      - run:
          name: "üéØ Ejecutar escaneo DAST con OWASP ZAP Docker"
          command: |
            # Crear directorio en el workspace
            mkdir -p ~/project/zap-reports
            chmod 777 ~/project/zap-reports

            echo "Usando OWASP ZAP desde Docker..."

            # Obtener IP del host
            HOST_IP=$(hostname -I | awk '{print $1}')
            echo "Usando IP del host: $HOST_IP"

            # Verificar que los servicios est√°n corriendo
            echo "Re-verificando servicios antes del escaneo..."
            curl -I http://localhost:3000 || echo "Frontend no responde"
            curl -I http://localhost:8000/admin/ || echo "Backend no responde"

            # Escanear Frontend
            echo "=========================================="
            echo "Escaneando Frontend en http://$HOST_IP:3000"
            echo "=========================================="
            docker run --rm \
              --add-host=host.docker.internal:$HOST_IP \
              -v ~/project/zap-reports:/zap/wrk/:rw \
              zaproxy/zap-stable zap-baseline.py \
              -t http://host.docker.internal:3000 \
              -r zap-frontend-report.html \
              -I || echo "‚ö†Ô∏è  Escaneo Frontend completado con alertas"

            echo ""
            echo "Verificando reporte frontend..."
            ls -lh ~/project/zap-reports/zap-frontend-report.html || echo "‚ùå Reporte frontend NO generado"

            # Escanear API
            echo ""
            echo "=========================================="
            echo "Escaneando API en http://$HOST_IP:8000/api/habits/"
            echo "=========================================="
            docker run --rm \
              --add-host=host.docker.internal:$HOST_IP \
              -v ~/project/zap-reports:/zap/wrk/:rw \
              zaproxy/zap-stable zap-baseline.py \
              -t http://host.docker.internal:8000/api/habits/ \
              -r zap-api-report.html \
              -I || echo "‚ö†Ô∏è  Escaneo API completado con alertas"

            echo ""
            echo "Verificando reporte API..."
            ls -lh ~/project/zap-reports/zap-api-report.html || echo "‚ùå Reporte API NO generado"

            echo ""
            echo "Contenido del directorio de reportes:"
            ls -la ~/project/zap-reports/

      - run:
          name: "üìä Resumen de an√°lisis DAST"
          command: |
            echo "=========================================="
            echo "üìä RESUMEN DE AN√ÅLISIS DIN√ÅMICO (DAST)"
            echo "=========================================="

            if [ -f ~/project/zap-reports/zap-frontend-report.html ]; then
              echo "‚úÖ Reporte DAST generado"
              echo ""
              echo "Reportes disponibles:"
              echo "  - Frontend: zap-frontend-report.html"
              echo "  - API: zap-api-report.html"
            fi
            echo "=========================================="

      - store_artifacts:
          path: ~/project/zap-reports
          destination: dast-reports

# ============================================
# WORKFLOWS
# ============================================
workflows:
  version: 2

  # Workflow de seguridad SAST & DAST
  security_pipeline:
    jobs:
      - sast_eslint:
          name: "üîç SAST - An√°lisis Est√°tico"

      - dast_owasp_zap:
          name: "üéØ DAST - An√°lisis Din√°mico"
          requires:
            - "üîç SAST - An√°lisis Est√°tico"
