name: ğŸ”’ Security Pipeline (SAST + DAST)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================
  # JOB 1: SAST - AnÃ¡lisis EstÃ¡tico con ESLint
  # ============================================
  sast-eslint:
    name: ğŸ” SAST - ESLint Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: habit-tracker-frontend/package.json

      - name: ğŸ“‹ Instalar dependencias
        run: |
          cd habit-tracker-frontend
          npm install

      - name: ğŸ” Ejecutar ESLint con anÃ¡lisis de seguridad
        run: |
          cd habit-tracker-frontend
          echo "=========================================="
          echo "ğŸ” SAST - Static Application Security Testing"
          echo "Herramienta: ESLint + eslint-plugin-security"
          echo "=========================================="
          echo ""

          npm run lint || true

          echo ""
          echo "=========================================="
          echo "ğŸ“Š RESUMEN DEL ANÃLISIS SAST"
          echo "=========================================="
          echo "âœ… AnÃ¡lisis completado"
          echo "Los warnings mostrados arriba indican posibles vulnerabilidades"

  # ============================================
  # JOB 2: DAST - AnÃ¡lisis DinÃ¡mico con OWASP ZAP
  # ============================================
  dast-owasp-zap:
    name: ğŸ¯ DAST - OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    needs: sast-eslint

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: habit-tracker-frontend/package.json

      - name: ğŸ”§ Configurar Backend Django
        run: |
          pip install -r requirements.txt
          python manage.py migrate --noinput
          echo "âœ… Backend configurado"

      - name: âš›ï¸  Build Frontend React
        run: |
          cd habit-tracker-frontend
          npm install
          npm run build
          echo "âœ… Frontend compilado"

      - name: ğŸš€ Iniciar aplicaciones en background
        run: |
          # Iniciar Django
          python manage.py runserver 0.0.0.0:8000 &
          DJANGO_PID=$!
          echo "Django PID: $DJANGO_PID"

          # Iniciar Frontend
          cd habit-tracker-frontend
          npx serve -s build -l 3000 &
          FRONTEND_PID=$!
          echo "Frontend PID: $FRONTEND_PID"

          # Esperar a que inicien
          echo "Esperando 15 segundos a que los servicios inicien..."
          sleep 15

          # Verificar que estÃ¡n corriendo
          curl -I http://localhost:3000 || echo "âš ï¸  Frontend no responde"
          curl -I http://localhost:8000/admin/ || echo "âš ï¸  Backend no responde"

      - name: ğŸ¯ OWASP ZAP - Escanear Frontend
        run: |
          echo "=========================================="
          echo "ğŸ¯ DAST - Dynamic Application Security Testing"
          echo "Herramienta: OWASP ZAP Baseline Scan"
          echo "Target: Frontend (http://localhost:3000)"
          echo "=========================================="
          echo ""

          docker run --rm --network host \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://localhost:3000 \
            -I || true

          echo ""
          echo "=========================================="
          echo "âœ… Escaneo Frontend completado"
          echo "=========================================="

      - name: ğŸ¯ OWASP ZAP - Escanear Backend API
        run: |
          echo ""
          echo "=========================================="
          echo "Target: Backend API (http://localhost:8000/api/habits/)"
          echo "=========================================="
          echo ""

          docker run --rm --network host \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://localhost:8000/api/habits/ \
            -I || true

          echo ""
          echo "=========================================="
          echo "âœ… Escaneo Backend completado"
          echo "=========================================="

      - name: ğŸ“Š Resumen Final
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "ğŸ“Š PIPELINE DE SEGURIDAD COMPLETADO"
          echo "========================================"
          echo ""
          echo "âœ… SAST (ESLint): AnÃ¡lisis estÃ¡tico completado"
          echo "âœ… DAST (OWASP ZAP): AnÃ¡lisis dinÃ¡mico completado"
          echo ""
          echo "Revisa los logs arriba para ver las vulnerabilidades detectadas:"
          echo "  - WARN-NEW: Vulnerabilidades nuevas encontradas"
          echo "  - FAIL-NEW: Vulnerabilidades crÃ­ticas"
          echo "  - PASS: Pruebas de seguridad pasadas"
          echo ""
          echo "========================================"
