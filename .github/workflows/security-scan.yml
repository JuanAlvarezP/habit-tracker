name: ğŸ”’ Security Pipeline (SAST + DAST)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================
  # JOB 1: SAST - AnÃ¡lisis EstÃ¡tico con ESLint
  # ============================================
  sast-eslint:
    name: ğŸ” SAST - ESLint Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: habit-tracker-frontend/package.json

      - name: ğŸ“‹ Instalar dependencias
        run: |
          cd habit-tracker-frontend
          npm install

      - name: ğŸ” Ejecutar ESLint con anÃ¡lisis de seguridad
        run: |
          cd habit-tracker-frontend
          echo "=========================================="
          echo "ğŸ” SAST - Static Application Security Testing"
          echo "Herramienta: ESLint + eslint-plugin-security"
          echo "=========================================="
          echo ""

          npm run lint || true

          echo ""
          echo "=========================================="
          echo "ğŸ“Š RESUMEN DEL ANÃLISIS SAST"
          echo "=========================================="
          echo "âœ… AnÃ¡lisis completado"
          echo "Los warnings mostrados arriba indican posibles vulnerabilidades"

  # ============================================
  # JOB 2: DAST - AnÃ¡lisis DinÃ¡mico con SQLMap
  # ============================================
  dast-sqlmap:
    name: ğŸ’‰ DAST - SQLMap Injection Scan
    runs-on: ubuntu-latest
    needs: sast-eslint

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: habit-tracker-frontend/package.json

      - name: ğŸ”§ Configurar Backend Django
        run: |
          pip install -r requirements.txt
          python manage.py migrate --noinput
          echo "âœ… Backend configurado"

      - name: âš›ï¸  Build Frontend React
        run: |
          cd habit-tracker-frontend
          npm install
          npm run build
          echo "âœ… Frontend compilado"

      - name: ğŸš€ Iniciar aplicaciÃ³n Django
        run: |
          # Iniciar Django en background
          python manage.py runserver 0.0.0.0:8000 &
          DJANGO_PID=$!
          echo "Django PID: $DJANGO_PID"

          # Esperar a que inicie
          echo "Esperando 15 segundos a que Django inicie..."
          sleep 15

          # Verificar que estÃ¡ corriendo
          curl -I http://localhost:8000/admin/ && echo "âœ… Django respondiendo" || echo "âš ï¸  Django no responde"

      - name: ğŸ’‰ SQLMap - Escanear API endpoints para inyecciones SQL
        run: |
          echo "=========================================="
          echo "ğŸ’‰ DAST - Dynamic Application Security Testing"
          echo "Herramienta: SQLMap - SQL Injection Scanner"
          echo "=========================================="
          echo ""

          # Instalar SQLMap
          sudo apt-get update -qq
          sudo apt-get install -y sqlmap

          echo "âœ… SQLMap instalado correctamente"
          sqlmap --version
          echo ""
          echo "=========================================="
          echo "ğŸ¯ Target 1: Vulnerable Search by ID"
          echo "=========================================="
          echo ""

          # Endpoint EXTREMADAMENTE vulnerable (GET con parÃ¡metro id)
          # ConfiguraciÃ³n agresiva para garantizar detecciÃ³n
          sqlmap -u "http://localhost:8000/api/vulnerable-search/?id=1" \
            --batch \
            --level=5 \
            --risk=3 \
            --dbms=SQLite \
            --technique=BEUSTQ \
            --threads=5 \
            --tamper=space2comment \
            -v 3 \
            --random-agent \
            --flush-session || true

          echo ""
          echo "=========================================="
          echo "ğŸ¯ Target 2: Vulnerable User Search"
          echo "=========================================="
          echo ""

          # Segundo endpoint vulnerable (GET con parÃ¡metro name)
          sqlmap -u "http://localhost:8000/api/vulnerable-login/?name=admin" \
            --batch \
            --level=5 \
            --risk=3 \
            --dbms=SQLite \
            --technique=BEUSTQ \
            --threads=5 \
            -v 3 \
            --random-agent \
            --flush-session || true

          echo ""
          echo "=========================================="
          echo "ğŸ¯ Target 3: Habits API (protegido)"
          echo "=========================================="
          echo ""

          # Endpoint protegido para comparaciÃ³n
          sqlmap -u "http://localhost:8000/api/habits/?id=1" \
            --batch \
            --level=3 \
            --risk=2 \
            -v 2 \
            --random-agent || true

      - name: ğŸ“Š Resumen Final
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "ğŸ“Š PIPELINE DE SEGURIDAD COMPLETADO"
          echo "========================================"
          echo ""
          echo "âœ… SAST (ESLint): AnÃ¡lisis estÃ¡tico completado"
          echo "âœ… DAST (SQLMap): AnÃ¡lisis de inyecciones SQL completado"
          echo ""
          echo "Revisa los logs arriba para ver las vulnerabilidades detectadas:"
          echo "  - [INFO] InformaciÃ³n sobre el escaneo"
          echo "  - [WARNING] Posibles vulnerabilidades encontradas"
          echo "  - [CRITICAL] Vulnerabilidades crÃ­ticas de SQL injection"
          echo ""
          echo "Si SQLMap encontrÃ³ inyecciones SQL, mostrarÃ¡:"
          echo "  - Parameter: [nombre] is vulnerable"
          echo "  - Type: [tipo de inyecciÃ³n]"
          echo "  - Payload: [payload que funcionÃ³]"
          echo ""
          echo "========================================"
